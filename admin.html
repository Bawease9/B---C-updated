<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin - Song Requests</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    #top-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      font-size: 18px;
    }
    table {
      margin: auto;
      border-collapse: collapse;
      width: 90%;
      margin-bottom: 40px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
    }
    th {
      background-color: #111;
      color: white;
    }
    .tipped {
      background-color: #fff8e1; /* pale yellow for tips */
      font-weight: bold;
    }
    .action-btn {
      padding: 6px 12px;
      margin-right: 6px;
      border: none;
      border-radius: 5px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }
    .action-btn:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
  <h1>üéπ Admin - Song Requests üé∂</h1>

  <div id="top-bar">
    <div>Total Requests: <span id="totalRequests">0</span></div>
    <button class="action-btn" onclick="resetTables()">Reset</button>
  </div>

  <table id="requestsTable">
    <thead>
      <tr>
        <th>Song #1</th>
        <th>Song #2</th>
        <th>Name</th>
        <th>Dedication</th>
        <th>Timestamp</th>
        <th>Tip</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Played Songs Section -->
  <h2 style="text-align:center;">‚úÖ Played Songs</h2>
  <table id="playedTable">
    <thead>
      <tr>
        <th>Song #1</th>
        <th>Song #2</th>
        <th>Name</th>
        <th>Dedication</th>
        <th>Timestamp</th>
        <th>Tip</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Songs We Don't Know Section -->
  <h2 style="text-align:center;">‚ùå Songs We Don't Know</h2>
  <table id="unknownTable">
    <thead>
      <tr>
        <th>Song #1</th>
        <th>Song #2</th>
        <th>Name</th>
        <th>Dedication</th>
        <th>Timestamp</th>
        <th>Tip</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
  const sheetURL = 'https://docs.google.com/spreadsheets/d/YOUR_SHEET_ID_HERE/gviz/tq?tqx=out:json';

  const requestsTable = document.querySelector("#requestsTable tbody");
  const playedTable = document.querySelector("#playedTable tbody");
  const unknownTable = document.querySelector("#unknownTable tbody");
  let renderedRows = new Set();

  function formatDate(timestamp) {
    const date = new Date(timestamp);
    const hours = date.getHours() % 12 || 12;
    const minutes = date.getMinutes().toString().padStart(2, '0');
    const ampm = date.getHours() >= 12 ? 'p.m.' : 'a.m.';
    return `${hours}:${minutes} ${ampm} ${date.getMonth()+1}/${date.getDate()}`;
  }

  function createRow(cells) {
    const tr = document.createElement("tr");
    const isTipped = cells[5]?.toLowerCase() === "tipped";
    if (isTipped) tr.classList.add("tipped");

    const [timestamp, song1, song2, name, dedication, tip] = [
      cells[0], cells[1], cells[2], cells[3], cells[4], cells[5] || ""
    ];

    [song1, song2, name, dedication, formatDate(timestamp), tip].forEach(val => {
      const td = document.createElement("td");
      td.textContent = val;
      tr.appendChild(td);
    });

    const actionTd = document.createElement("td");
    const playBtn = document.createElement("button");
    playBtn.textContent = "Mark as Played";
    playBtn.className = "action-btn";
    playBtn.onclick = () => {
      tr.remove();
      playedTable.appendChild(tr);
    };

    const dontKnowBtn = document.createElement("button");
    dontKnowBtn.textContent = "Don't Know";
    dontKnowBtn.className = "action-btn";
    dontKnowBtn.onclick = () => {
      tr.remove();
      unknownTable.appendChild(tr);
    };

    actionTd.appendChild(playBtn);
    actionTd.appendChild(dontKnowBtn);
    tr.appendChild(actionTd);
    return tr;
  }

  function loadRequests() {
    fetch(sheetURL)
      .then(res => res.text())
      .then(text => {
        const json = JSON.parse(text.substring(47).slice(0, -2));
        const rows = json.table.rows;
        document.getElementById("totalRequests").textContent = rows.length;

        rows.forEach(row => {
          const id = row.c.map(c => c?.v).join("|");
          if (!renderedRows.has(id)) {
            const tr = createRow(row.c.map(c => c?.v || ""));
            requestsTable.insertBefore(tr, requestsTable.firstChild);
            renderedRows.add(id);
          }
        });
      });
  }

  function resetTables() {
    requestsTable.innerHTML = "";
    playedTable.innerHTML = "";
    unknownTable.innerHTML = "";
    renderedRows.clear();
    loadRequests();
  }

  loadRequests();
  setInterval(loadRequests, 5000);
</script>
</body>
</html>
